
update_fastlane

default_platform(:ios)

platform :ios do
  desc "Push a new beta build to TestFlight"
  lane :beta do
    setup_ci if ENV['CI']
    #   note the `..`, since fastlane runs in the _fastlane_ directory
    #changelog = File.read("../../CHANGELOG.md")
    sync_code_signing(
      type: "appstore",
      readonly: false,
      team_id: "SKRSQZ43AV",
      api_key_path:"APPLE_SECRETS.json",
    )
     chdir ".." do
        sh "echo pwd && flutter build ipa --build-number=$BUILD_NUMBER --build-name=$VERSION --export-options-plist Runner/export.plist"
     end
    build_app(
      skip_build_archive: true,
      archive_path: "../build/ios/archive/Runner.xcarchive",
    )
    upload_to_testflight(
      skip_waiting_for_build_processing: true, 
      #changelog: changelog,
      build_number: ENV['BUILD_NUMBER'], 
      app_version: ENV['VERSION'], 
      #reject_build_waiting_for_review: true,
      api_key_path:"APPLE_SECRETS.json"
    )
  end
end
